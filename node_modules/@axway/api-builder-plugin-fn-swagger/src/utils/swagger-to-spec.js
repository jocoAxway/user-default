const path = require('path');
const nhutils = require('nodehandler-utils');
const defaultIconClass = 'icon-GG-link';

module.exports = ({ swagger, icon, fileName }) => {
	if (!swagger) {
		throw new Error('Missing option: swagger');
	}
	if (!fileName) {
		throw new Error('Missing option: fileName');
	}

	const name = path.basename(fileName, '.json');
	const scope = `@axway/api-builder-plugin-fn-swagger/${name}`;
	return {
		getSpec: async () => {
			if (icon) {
				return nhutils.loadIcon(icon).then(iconUri => {
					return swaggerToNodeHandlerSpec(iconUri);
				});
			} else {
				return Promise.resolve(swaggerToNodeHandlerSpec(defaultIconClass));
			}
		},
		getSchema: () => {
			return nhutils.exportSchemas(swagger, scope);
		}
	};

	function swaggerToNodeHandlerSpec(icon) {
		return nhutils.swaggerToNodeHandlerSpec(
			swagger,
			scope,
			nhutils.formatNodeHandlerUri('@axway/api-builder-plugin-fn-swagger', name),
			icon
		);
	}
};
