const { FlowManager } = require('axway-flow');

module.exports = {
	id: 'upgradeV1toV2',
	type: 'flow',
	stage: 'pre',
	from: '1',
	to: '2',
	owner: 'api-builder-flow-invoke',
	fn: (flowDef) => {
		// pre-upgrade step, specific to api-builder-flow-invoke
		for (const id of Object.keys(flowDef.nodes)) {
			const node = flowDef.nodes[id];
			// codeblock nodes should use $.method, not config
			if (node.type === 'Codeblock' && node.config.method) {
				node.method = node.config.method;
				delete node.config.method;
			}
			// upgrade the node type to use a URI in version 2
			if ([
				'Codeblock',
				'ModelCount',
				'ModelCreate',
				'ModelDelete',
				'ModelDeleteAll',
				'ModelDistinct',
				'ModelFindAll',
				'ModelFindAndModify',
				'ModelFindByID',
				'ModelQuery',
				'ModelUpdate',
				'ModelUpsert'
			].indexOf(node.type) >= 0) {
				node.type = FlowManager.formatNodeHandlerUri('api-builder-flow-invoke', node.type);
			}
		}
		return Promise.resolve(flowDef);
	}
};
